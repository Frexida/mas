openapi: 3.0.3
info:
  title: mas-tmux HTTP API
  description: |
    tmuxセッションにメッセージを送信するためのHTTP APIです。
    このAPIを使用することで、外部アプリケーションからtmuxウィンドウやペインに
    メッセージを送信したり、コマンドを実行したりすることができます。
  version: 1.0.0
  contact:
    name: mas-tmux support
  license:
    name: MIT

servers:
  - url: http://localhost:8765
    description: ローカル開発環境（デフォルト）
  - url: http://{host}:{port}
    description: カスタムサーバー
    variables:
      host:
        default: 0.0.0.0
        description: サーバーのホストアドレス
      port:
        default: '8765'
        description: サーバーのポート番号

tags:
  - name: Message
    description: tmuxセッションへのメッセージ送信

paths:
  /message:
    post:
      summary: tmuxセッションにメッセージを送信
      description: |
        指定されたtmuxウィンドウまたはペインにメッセージを送信します。
        executeフラグを使用することで、メッセージをコマンドとして実行することも可能です。
      tags:
        - Message
      operationId: sendMessage
      requestBody:
        description: 送信するメッセージの詳細
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MessageRequest'
            examples:
              simpleMessage:
                summary: シンプルなメッセージ送信
                value:
                  target: window1
                  message: Hello, tmux!
              executeCommand:
                summary: コマンドの実行
                value:
                  target: window2
                  message: ls -la
                  execute: true
              broadcastMessage:
                summary: 全ウィンドウへのブロードキャスト
                value:
                  target: all
                  message: System maintenance in 5 minutes

      responses:
        '200':
          description: メッセージが正常に受理された
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                status: acknowledged
                target: window1
                timestamp: '2024-12-12T15:30:00.000Z'

        '400':
          description: リクエストが不正
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingFields:
                  summary: 必須フィールドが欠けている
                  value:
                    error: target and message required
                invalidJson:
                  summary: JSONフォーマットが不正
                  value:
                    error: Unexpected token in JSON

      x-codeSamples:
        - lang: curl
          label: cURL
          source: |
            curl -X POST http://localhost:8765/message \
              -H "Content-Type: application/json" \
              -d '{"target": "window1", "message": "Hello, tmux!"}'

        - lang: JavaScript
          label: JavaScript (fetch)
          source: |
            fetch('http://localhost:8765/message', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                target: 'window1',
                message: 'Hello, tmux!'
              })
            })
            .then(response => response.json())
            .then(data => console.log(data));

        - lang: Python
          label: Python (requests)
          source: |
            import requests

            response = requests.post(
                'http://localhost:8765/message',
                json={
                    'target': 'window1',
                    'message': 'Hello, tmux!'
                }
            )
            print(response.json())

    options:
      summary: CORS プリフライトリクエスト
      description: ブラウザからのクロスオリジンリクエストのためのプリフライト
      tags:
        - Message
      responses:
        '200':
          description: CORS設定を返す
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
                example: '*'
            Access-Control-Allow-Methods:
              schema:
                type: string
                example: POST, OPTIONS
            Access-Control-Allow-Headers:
              schema:
                type: string
                example: Content-Type

components:
  schemas:
    MessageRequest:
      type: object
      required:
        - target
        - message
      properties:
        target:
          type: string
          description: |
            メッセージの送信先。以下の形式がサポートされています：
            - ウィンドウ名（例: "window1"）
            - ウィンドウインデックス（例: "0", "1"）
            - ペイン指定（例: "window1.0", "0.1"）
            - "all"（すべてのウィンドウ）
            - "current"（現在のウィンドウ）
          example: window1

        message:
          type: string
          description: |
            送信するメッセージまたは実行するコマンド。
            executeフラグがtrueの場合、このメッセージはシェルコマンドとして実行されます。
          example: Hello, tmux!

        execute:
          type: boolean
          description: |
            trueの場合、messageをコマンドとして実行します。
            falseまたは省略時は、テキストとして送信します。
          default: false
          example: false

    SuccessResponse:
      type: object
      required:
        - status
        - target
        - timestamp
      properties:
        status:
          type: string
          description: レスポンスステータス
          enum: [acknowledged]
          example: acknowledged

        target:
          type: string
          description: メッセージが送信された対象
          example: window1

        timestamp:
          type: string
          format: date-time
          description: メッセージを受理した時刻（ISO 8601形式）
          example: '2024-12-12T15:30:00.000Z'

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: エラーメッセージの詳細
          example: target and message required

  securitySchemes:
    ApiKey:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        将来的な認証機能のためのAPIキー。
        現在は実装されていませんが、本番環境では認証の追加を推奨します。