# OpenAPI Extension for Session Management
# This file contains the new endpoints and schemas to be merged with the main openapi.yaml

paths:
  /sessions:
    get:
      summary: List all MAS sessions
      description: |
        Returns a list of all active and inactive MAS tmux sessions.
        Sessions are identified by their UUID and include status information.
      tags:
        - Sessions
      operationId: listSessions
      parameters:
        - name: status
          in: query
          description: Filter sessions by status
          schema:
            type: string
            enum: [active, inactive, all]
            default: all
        - name: limit
          in: query
          description: Maximum number of sessions to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        '200':
          description: List of sessions retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      $ref: '#/components/schemas/SessionInfo'
                  total:
                    type: integer
                    description: Total number of sessions
                  timestamp:
                    type: string
                    format: date-time
              example:
                sessions:
                  - sessionId: "550e8400-e29b-41d4-a716-446655440000"
                    tmuxSession: "mas-550e8400"
                    status: "active"
                    workingDir: "/home/user/dev/mas"
                    startedAt: "2024-12-17T10:30:00Z"
                    agentCount: 13
                    httpServerStatus: "running"
                total: 1
                timestamp: "2024-12-17T14:30:00Z"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /sessions/{sessionId}:
    get:
      summary: Get session details
      description: |
        Returns detailed information about a specific MAS session,
        including agent statuses and window configuration.
      tags:
        - Sessions
      operationId: getSession
      parameters:
        - name: sessionId
          in: path
          required: true
          description: The session UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Session details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionDetail'
              example:
                sessionId: "550e8400-e29b-41d4-a716-446655440000"
                tmuxSession: "mas-550e8400"
                status: "active"
                workingDir: "/home/user/dev/mas"
                startedAt: "2024-12-17T10:30:00Z"
                lastActivity: "2024-12-17T14:25:00Z"
                agentCount: 13
                httpServerStatus: "running"
                agents:
                  - agentId: "00"
                    name: "Meta Manager"
                    status: "running"
                    window: "meta"
                    pane: 0
                  - agentId: "10"
                    name: "Design Manager"
                    status: "running"
                    window: "design"
                    pane: 0
                windows:
                  - name: "meta"
                    index: 0
                    paneCount: 1
                    active: false
                  - name: "design"
                    index: 1
                    paneCount: 4
                    active: true
        '404':
          $ref: '#/components/responses/SessionNotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /sessions/{sessionId}/connect:
    post:
      summary: Connect to an existing session
      description: |
        Establishes a connection to an existing MAS session.
        This endpoint prepares the session for interaction and returns
        connection details.
      tags:
        - Sessions
      operationId: connectToSession
      parameters:
        - name: sessionId
          in: path
          required: true
          description: The session UUID
          schema:
            type: string
            format: uuid
      requestBody:
        description: Connection options
        content:
          application/json:
            schema:
              type: object
              properties:
                reconnect:
                  type: boolean
                  description: Force reconnection if already connected
                  default: false
                window:
                  type: string
                  description: Specific window to focus on connection
                  enum: [meta, design, development, business]
      responses:
        '200':
          description: Successfully connected to session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectionInfo'
              example:
                sessionId: "550e8400-e29b-41d4-a716-446655440000"
                tmuxSession: "mas-550e8400"
                attachCommand: "tmux attach-session -t mas-550e8400"
                status: "connected"
                timestamp: "2024-12-17T14:30:00Z"
                connectionDetails:
                  windows: 4
                  activeAgents: 13
                  focusedWindow: "design"
        '404':
          $ref: '#/components/responses/SessionNotFound'
        '409':
          description: Session already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /sessions/{sessionId}/stop:
    post:
      summary: Stop a MAS session
      description: |
        Gracefully stops a MAS session and all its agents.
        This is equivalent to running 'mas stop' for the session.
      tags:
        - Sessions
      operationId: stopSession
      parameters:
        - name: sessionId
          in: path
          required: true
          description: The session UUID
          schema:
            type: string
            format: uuid
      requestBody:
        description: Stop options
        content:
          application/json:
            schema:
              type: object
              properties:
                force:
                  type: boolean
                  description: Force stop without cleanup
                  default: false
      responses:
        '200':
          description: Session stopped successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [stopped, terminated]
                  timestamp:
                    type: string
                    format: date-time
        '404':
          $ref: '#/components/responses/SessionNotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  schemas:
    SessionInfo:
      type: object
      required:
        - sessionId
        - tmuxSession
        - status
        - workingDir
        - startedAt
      properties:
        sessionId:
          type: string
          format: uuid
          description: Unique session identifier
        tmuxSession:
          type: string
          description: Tmux session name (mas-XXXXXXXX format)
          pattern: '^mas-[a-f0-9]{8}$'
        status:
          type: string
          enum: [active, inactive, terminated]
          description: Current session status
        workingDir:
          type: string
          description: Working directory path
        startedAt:
          type: string
          format: date-time
          description: Session start timestamp
        agentCount:
          type: integer
          minimum: 0
          description: Number of agents in the session
        httpServerStatus:
          type: string
          enum: [running, stopped]
          description: HTTP server status

    SessionDetail:
      allOf:
        - $ref: '#/components/schemas/SessionInfo'
        - type: object
          properties:
            lastActivity:
              type: string
              format: date-time
              description: Last activity timestamp
            agents:
              type: array
              items:
                $ref: '#/components/schemas/AgentStatus'
            windows:
              type: array
              items:
                $ref: '#/components/schemas/WindowInfo'
            config:
              $ref: '#/components/schemas/AgentConfig'
              description: Original agent configuration

    AgentStatus:
      type: object
      required:
        - agentId
        - name
        - status
      properties:
        agentId:
          type: string
          pattern: '^[0-9]{2}$'
          description: Two-digit agent ID
        name:
          type: string
          description: Agent display name
        status:
          type: string
          enum: [running, stopped, error]
        window:
          type: string
          description: Tmux window name
        pane:
          type: integer
          description: Tmux pane index

    WindowInfo:
      type: object
      required:
        - name
        - index
        - paneCount
      properties:
        name:
          type: string
          description: Window name
        index:
          type: integer
          description: Window index
        paneCount:
          type: integer
          description: Number of panes in window
        active:
          type: boolean
          description: Whether this is the active window

    ConnectionInfo:
      type: object
      required:
        - sessionId
        - tmuxSession
        - status
        - timestamp
      properties:
        sessionId:
          type: string
          format: uuid
        tmuxSession:
          type: string
        attachCommand:
          type: string
          description: Command to attach to tmux session
        status:
          type: string
          enum: [connected, failed]
        timestamp:
          type: string
          format: date-time
        connectionDetails:
          type: object
          properties:
            windows:
              type: integer
            activeAgents:
              type: integer
            focusedWindow:
              type: string

    ErrorResponse:
      type: object
      required:
        - error
        - timestamp
      properties:
        error:
          type: string
          description: Error message
        details:
          type: object
          description: Additional error details
        timestamp:
          type: string
          format: date-time

  responses:
    SessionNotFound:
      description: Session not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Session not found"
            details:
              sessionId: "550e8400-e29b-41d4-a716-446655440000"
            timestamp: "2024-12-17T14:30:00Z"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Internal server error"
            details:
              message: "Failed to execute tmux command"
            timestamp: "2024-12-17T14:30:00Z"

tags:
  - name: Sessions
    description: MAS session management operations