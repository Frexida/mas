# Isolate Session Workspaces

## Summary
複数のMASセッションを同時に実行可能にするため、各セッションを独立したワークスペースディレクトリに分離する。これにより、セッション間の干渉を防ぎ、真のマルチセッション対応を実現する。

## Problem
現在のMASアーキテクチャには以下の問題がある：

1. **単一セッション前提**: すべてのセッションが同じ `unit/` と `workflows/` ディレクトリを共有
2. **セッション間の干渉**: 複数セッションが同時実行された場合、ファイルシステムレベルで競合が発生
3. **UUID未使用**: APIで生成されたセッションUUIDが実際のtmuxセッション名に反映されていない
4. **リソース管理の困難**: セッションごとのログ、設定、作業ファイルの管理が困難
5. **並行実行の制限**: 安全に複数セッションを並行実行できない

これらの問題により、MAS APIを通じた真のマルチセッション対応が実現できていない。

## Solution
セッションごとに独立したワークスペースディレクトリ構造を導入する：

```
mas/
├── sessions/                    # セッション分離ルート（新規）
│   ├── {session-uuid}/         # セッションごとの独立ディレクトリ
│   │   ├── .session            # セッションメタデータ
│   │   ├── unit/               # セッション専用ユニット
│   │   ├── workflows/          # セッション専用ワークフロー
│   │   ├── logs/               # セッション専用ログ
│   │   └── config.json         # セッション設定
│   └── .sessions.index         # アクティブセッションのレジストリ
├── unit/                        # ユニットテンプレート（読み取り専用）
└── workflows/                   # ワークフローテンプレート（読み取り専用）
```

主要な変更点：
1. セッション作成時にUUIDベースのディレクトリを作成
2. テンプレートからユニット/ワークフローをコピー
3. tmuxセッション名にUUIDプレフィックスを使用
4. セッションメタデータをディレクトリ内に保存
5. セッション単位でのリソース管理を実現

## Outcomes
- **完全な分離**: 各セッションが独立した作業領域を持つ
- **並行実行**: 複数セッションを安全に同時実行可能
- **リソース追跡**: セッションごとのリソース使用状況を明確に管理
- **簡単なクリーンアップ**: セッション終了時にディレクトリごと削除可能
- **監査証跡**: セッションごとの作業履歴を保持

## Scope
### In Scope
- `sessions/{uuid}/` ディレクトリ構造の実装
- セッション作成時のワークスペース初期化
- API `/runs` エンドポイントの更新
- `mas_refactored.sh` のセッション管理更新
- セッションメタデータ管理機能
- セッション一覧・詳細取得API
- 後方互換性のためのレガシーモード維持

### Out of Scope
- 自動クリーンアップ機能（ユーザーのリクエストにより除外）
- セッションアーカイブ機能
- ガベージコレクション
- HTTPサーバーのポート動的割り当て
- セッション間通信機能

## Constraints
- 既存のレガシーモード（単一セッション）との後方互換性を維持
- セッションUUIDはRFC 4122準拠のVersion 4形式
- tmuxセッション名は英数字、ハイフン、アンダースコアのみ使用
- セッションディレクトリは `mas/sessions/` 配下に配置
- テンプレートディレクトリ（`unit/`, `workflows/`）は読み取り専用として扱う