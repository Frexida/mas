# Tasks: HonoベースAPIサーバーとシェルスクリプトモジュール化

## Phase 1: APIサーバー構築（3-5日）

### 1. Honoプロジェクトのセットアップ
- [ ] `api/`ディレクトリの作成
- [ ] package.jsonの初期化（bun init）
- [ ] Honoと必要な依存関係のインストール（hono, zod）
- [ ] TypeScript設定（tsconfig.json）
- [ ] 基本的なディレクトリ構造の作成（routes/, types/, validators/）

### 2. 基本的なサーバー実装
- [ ] `api/server.ts`の作成
- [ ] CORSミドルウェアの設定
- [ ] ログミドルウェアの設定
- [ ] エラーハンドリングの実装
- [ ] ヘルスチェックエンドポイント（/health）の実装

### 3. /messageエンドポイントの移植
- [ ] `api/routes/message.ts`の作成
- [ ] リクエストバリデーション（Zod schema）
- [ ] send_message.shの呼び出し処理
- [ ] レスポンス形式の実装
- [ ] エラーハンドリング

### 4. /runsエンドポイントの実装
- [ ] `api/routes/runs.ts`の作成
- [ ] OpenAPI仕様に基づくスキーマ定義
- [ ] mas.sh startへの委譲処理
- [ ] セッションID生成と返却
- [ ] 設定ファイルの一時保存処理

### 5. /statusエンドポイントの実装
- [ ] `api/routes/status.ts`の作成
- [ ] tmuxセッション状態の取得
- [ ] エージェント状態の収集
- [ ] レスポンス形式の定義

## Phase 2: シェルスクリプトモジュール化（3-5日）

### 6. lib/tmux.shの作成
- [ ] mas.shからtmux関連関数を抽出
- [ ] create_session関数の実装
- [ ] create_window関数の実装
- [ ] split_panes関数の実装
- [ ] attach_session関数の実装

### 7. lib/agent.shの作成
- [ ] エージェント初期化関数の抽出
- [ ] init_agent関数の実装
- [ ] start_agent関数の実装
- [ ] stop_agent関数の実装
- [ ] get_agent_model関数の実装（role別モデル割り当て）

### 8. lib/message.shの作成
- [ ] send_message.shのコア機能を抽出
- [ ] route_message関数の実装
- [ ] expand_target関数の実装（グループ展開）
- [ ] get_window_and_pane関数の移植
- [ ] broadcast_message関数の実装

### 9. lib/session.shの作成
- [ ] セッション管理機能の抽出
- [ ] generate_session_name関数の実装
- [ ] save_session_info関数の実装
- [ ] get_session_status関数の実装
- [ ] cleanup_session関数の実装

### 10. mas.shのリファクタリング
- [ ] モジュールのsource処理追加
- [ ] 重複コードの削除
- [ ] 各コマンド関数のモジュール呼び出しへの変更
- [ ] --configオプションのサポート追加
- [ ] 後方互換性の確認

## Phase 3: 統合とテスト（2-3日）

### 11. APIサーバーの起動スクリプト
- [ ] start_api.shの作成
- [ ] systemdサービスファイルの更新
- [ ] 環境変数の設定（MAS_API_PORT等）
- [ ] ログ出力の設定

### 12. APIテストの作成
- [ ] `api/tests/`ディレクトリの作成
- [ ] /messageエンドポイントのテスト
- [ ] /runsエンドポイントのテスト
- [ ] /statusエンドポイントのテスト
- [ ] エラーケースのテスト

### 13. シェルスクリプトテストの作成
- [ ] `tests/`配下にモジュールテストを追加
- [ ] tmux.shのテスト
- [ ] agent.shのテスト
- [ ] message.shのテスト
- [ ] session.shのテスト

### 14. 統合テストの実施
- [ ] API経由でのセッション作成テスト
- [ ] メッセージ送信の動作確認
- [ ] 既存CLIコマンドの互換性確認
- [ ] エラーシナリオのテスト

### 15. ドキュメントの更新
- [ ] README.mdのAPI説明追加
- [ ] APIエンドポイントのドキュメント
- [ ] モジュール構造の説明
- [ ] 移行ガイドの作成

## 検証項目

### 機能検証
- [ ] 全てのAPIエンドポイントが正常に動作する
- [ ] 既存のCLIコマンドが変わらず動作する
- [ ] tmuxセッションが正しく作成される
- [ ] エージェントへのメッセージが正しく配信される

### 性能検証
- [ ] APIレスポンス時間が100ms以内
- [ ] 並行リクエストの処理が可能
- [ ] メモリ使用量が適切

### 互換性検証
- [ ] 既存のスクリプトとの互換性
- [ ] 既存の設定ファイルとの互換性
- [ ] 既存のテストが全て通る

## リスク管理

### 識別されたリスク
1. **シェルスクリプトのモジュール化による不具合**
   - 緩和策: 段階的な移行と十分なテスト

2. **APIサーバーの安定性**
   - 緩和策: エラーハンドリングの徹底とログ監視

3. **パフォーマンスの低下**
   - 緩和策: プロファイリングと最適化

## 完了条件

- 全てのチェック項目が完了している
- テストカバレッジが既存レベル以上
- ドキュメントが更新されている
- レビューが完了している