# 実装監査: APIバックエンドとOpenAPI仕様の不整合

## 概要
現在のHono APIバックエンド実装とOpenAPI仕様（openapi.yaml）の間に重大な不整合が存在します。この提案は、実装と仕様の乖離を詳細に文書化し、品質問題を明確にすることを目的とします。

## 現状の問題

### 1. 仕様と実装の重大な不整合

#### `/runs` エンドポイント
**OpenAPI仕様:**
- エージェント構成を受け取り、UUIDベースのセッションを作成
- 最大4ユニット（メタマネージャー + 最大4ユニット）をサポート
- 詳細な構成例を提供

**実際の実装:**
- `mas.sh start --config` を呼び出し（存在しないスクリプト）
- mas.shは構成ファイルオプションをサポートしていない
- UUIDではなくタイムスタンプベースのセッションID生成
- エージェント構成の処理が未実装

#### `/message` エンドポイント
**OpenAPI仕様:**
- tmuxセッションへの柔軟なメッセージ送信
- 様々なターゲット形式をサポート（window名、agent-ID、all等）

**実際の実装:**
- `mas_refactored.sh send` を使用（最近修正）
- OpenAPI仕様の `SuccessResponse` スキーマと異なるレスポンス形式
  - 仕様: `status: "acknowledged"`
  - 実装: `status: "sent" | "failed"`

### 2. 文書化されていないエンドポイント

#### `/status` エンドポイント
- 実装には存在するがOpenAPI仕様に記載なし
- セッション状態、エージェント一覧、HTTPサーバー状態を返す
- `/health` とは異なる目的

#### `/health` エンドポイント
- 最小限の実装のみ（OpenAPI仕様にも記載なし）

### 3. バリデーションの不一致

#### Agent ID バリデーション
**仕様:** パターン `^[0-9]{2}$`（任意の2桁数字）
**実装:** パターン `^[0-3][0-3]$`（00-33のみ）

#### Unit制限
**仕様:** 最大4ユニット
**実装:** 最大3ユニット（コード内制限）

### 4. 実装の品質問題

1. **存在しないスクリプトへの依存**
   - `/runs` が `mas.sh start --config` を呼び出すが、mas.shに`--config`オプションなし
   - 実際には `mas_refactored.sh` を使用すべき

2. **エラーハンドリングの不足**
   - tmuxセッション作成失敗時の適切なエラーメッセージなし
   - JSON解析エラーが Cloudflare 経由で発生

3. **不完全な状態管理**
   - セッションの実際の状態とAPIレスポンスの不一致
   - エージェントの起動確認なし

## 影響範囲

### ユーザーへの影響
- API仕様書（Swagger UI）を見て実装したクライアントが動作しない
- `/runs` エンドポイントが完全に機能不全
- エラーメッセージが不親切で問題の特定が困難

### システムへの影響
- MAS UIからのエージェント起動が不可能
- APIを通じた自動化が実現できない
- 監視・管理機能の欠如

## 推奨される対応

### 緊急対応（Phase 1）
1. `/runs` エンドポイントの修正
   - `mas_refactored.sh` への正しい統合
   - 設定ファイル処理の実装

2. レスポンススキーマの統一
   - OpenAPI仕様に合わせた実装修正
   - または仕様の現実的な更新

### 中期対応（Phase 2）
1. `/status` エンドポイントの仕様化
2. エラーハンドリングの改善
3. 統合テストの追加

### 長期対応（Phase 3）
1. 完全なAPI実装
2. WebSocket対応（リアルタイム状態更新）
3. 認証・認可の実装

## 結論

現在のAPIバックエンドは「ボロボロ」という評価が妥当です。主要な機能（`/runs`）が動作せず、仕様と実装が大きく乖離しています。早急な修正が必要です。