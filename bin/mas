#!/usr/bin/env node

/**
 * MAS CLI - Node.js wrapper for mas-core.sh
 * This script acts as an entry point for npm-installed MAS
 */

import { spawn, execSync } from 'child_process';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { existsSync } from 'fs';
import { homedir } from 'os';
import chalk from 'chalk';

// Get directory paths
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const MAS_HOME = join(__dirname, '..');

// Path to the core bash script
const masCore = join(MAS_HOME, 'mas-core.sh');

// Check if mas-core.sh exists
if (!existsSync(masCore)) {
  console.error(chalk.red('Error: mas-core.sh not found at'), masCore);
  console.error(chalk.yellow('Please ensure MAS is properly installed.'));
  process.exit(1);
}

// Check for required dependencies
const checkDependencies = () => {
  const dependencies = ['bash', 'tmux'];
  const missing = [];

  for (const dep of dependencies) {
    const checkCmd = process.platform === 'win32' ? 'where' : 'which';
    try {
      execSync(`${checkCmd} ${dep}`, { stdio: 'ignore' });
    } catch {
      missing.push(dep);
    }
  }

  if (missing.length > 0) {
    console.error(chalk.red('Missing required dependencies:'), missing.join(', '));
    console.error(chalk.yellow('Please install the missing dependencies and try again.'));
    if (process.platform === 'darwin') {
      console.error(chalk.cyan('On macOS, you can install them with: brew install', missing.join(' ')));
    } else if (process.platform === 'linux') {
      console.error(chalk.cyan('On Linux, you can install them with your package manager (apt, yum, etc.)'));
    }
    process.exit(1);
  }
};

// Check dependencies before running
checkDependencies();

// Setup environment variables
const env = {
  ...process.env,
  MAS_HOME,
  MAS_NPM_VERSION: process.env.npm_package_version || '2.1.0',
  MAS_INSTALL_TYPE: 'npm',
  MAS_DATA_DIR: process.env.MAS_DATA_DIR || join(homedir(), '.mas')
};

// Handle signals properly
const handleSignal = (signal) => {
  if (child) {
    child.kill(signal);
  }
};

process.on('SIGINT', () => handleSignal('SIGINT'));
process.on('SIGTERM', () => handleSignal('SIGTERM'));

// Spawn the bash script
const child = spawn('bash', [masCore, ...process.argv.slice(2)], {
  stdio: 'inherit',
  env,
  shell: false
});

// Handle child process events
child.on('error', (err) => {
  console.error(chalk.red('Failed to start MAS:'), err.message);
  process.exit(1);
});

child.on('exit', (code, signal) => {
  if (signal) {
    process.exit(128 + signal);
  }
  process.exit(code || 0);
});